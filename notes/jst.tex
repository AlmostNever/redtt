\documentclass{article}
\usepackage{stmaryrd}
\usepackage[landscape]{geometry}
\usepackage{fullpage}
\usepackage{jst}
\usepackage{mathpartir}
\usepackage{notation}

\newcommand\Eval[3]{
  \FmtFam{
    {\left\llbracket\FmtTm{#1}\right\rrbracket}_{\FmtVal{#2}}^{\FmtVal{#3}}
  }
}

\newcommand\ForceEq[3]{\FmtRst{#1}\vDash\FmtFam{#2}=\FmtFam{#2}}
\newcommand\ForceTrue[2]{\FmtRst{#1}\vDash\FmtFam{#2}}
\newcommand\ForceTest[3]{\FmtRst{#1}\vDash\FmtFam{#2}\Downarrow\FmtVal{#3}}

\title{cubical evaluation semantics}
\author{Carlo Angiuli \and Jon Sterling}

\begin{document}
\maketitle

I've been thinking a bit more carefully about the evaluation semantics and the
semantic domain. What I think we want to do is take a term and an environment
and return a family of values (indexed in restrictions); but crucially, I think
it is important that the environment be a vector of \emph{values} and not of
value-families. By studying carefully the case for instantiating closures
(where the rubber meets the road for variables), I think it becomes clear that
this is the right way.

To interpret a variable, we just project from the environment and ignore the
restriction. I think the way that we had been thinking of doing it would result
in the restriction from inside the closure infecting the argument.

\bigskip


Colors: \FmtTm{terms}, \FmtFam{value families}, \FmtVal{values},
\FmtRst{restrictions}. I am writing $\Rst{\phi}{F}$ to mean the reindexing of a
family by a restriction.

\begin{align*}
  \Eval{
    \TLam{M}
  }{\rho}{\pi}
  &=
  \Fam{\phi}{
    \VLam{
      \VClo{M}{\rho}{\pi}{\phi}
    }
  }
  \\
  \Eval{
    \TPi{A}{B}
  }{\rho}{\pi}
  &=
  \Fam{\phi}{
    \VPi{
      \Rst{\phi}{\Eval{A}{\rho}{\pi}}
    }{
      \VClo{B}{\rho}{\pi}{\phi}
    }
  }
  \\
  \Eval{
    \TApp{M}{N}
  }{\rho}{\pi}
  &=
  \SemApp{
    \Eval{M}{\rho}{\pi}
  }{
    \Eval{N}{\rho}{\pi}
  }
  \\
  \Eval{
    \TVar{i}
  }{\rho}{\pi}
  &=
  \Fam{\_}{
    \rho_i
  }
\end{align*}

We write $\ForceTest{\phi}{F}{V}$ as a shorthand for
$\FamTest{F}{\phi}\equiv\FmtVal{V}$.

\begin{mathparpagebreakable}
  \inferrule{
    \ForceTest{\phi}{F}{
      \VLam{
        \VClo{M}{\rho}{\pi}{\psi}
      }
    }
  }{
    \ForceTest{\phi}{
      \SemApp{F}{N}
    }{
      \FamTest{
        \Eval{M}{\Squares*{\rho, \FamTest{N}{\phi}}}{\pi}
      }{
        \psi
      }
    }
  }
  \and
  \inferrule{
    \ForceTest{\phi}{F}{\VUp{C}{R}}
    \\
    \ForceTest{\RstId}{C}{\VPi{A}{\VClo{B}{\rho}{\pi}{\psi}}}
  }{
    \ForceTest{\phi}{
      \SemApp{F}{N}
    }{
      \VUp{
        \Rst{\psi}{\Eval{B}{\Squares*{\rho,\FamTest{N}{\phi}}}{\pi}}
      }{
        \Parens*{
          \Fam{\chi}{
            \VApp{
              \Rst{\chi}{R}
            }{
              \Rst{\chi\circ\phi}{N}
            }
          }
        }
      }
    }
  }
  \and
  \inferrule{
    \ForceTest{\phi}{F}{
      \VCoe{r}{r'}{
        \VAbs{\alpha}{C}
      }{M}
    }
    \\
    \ForceTest{\RstId}{C}{
      \VPi{A}{\VClo{B}{\rho}{\pi}{\psi}}
    }
  }{
    \ForceTest{\phi}{
      \SemApp{F}{N}
    }{
      \Fresh{\beta}{
        \Fresh{\gamma}{
          \SemCoe{r}{r'}{
            \VAbs{\beta}{
              \Eval{B}{
                \Squares*{
                  \rho,
                  \SemCoe{r'}{\beta}{
                    \VAbs{\gamma}{
                      \Act{\Swap{\gamma}{\alpha}}{A}
                    }
                  }{
                    \FamTest{N}{\phi}
                  }
                }
              }{
                \Squares*{\pi, \Swap{\beta}{\alpha}}
              }
            }
          }{
            \SemApp{M}{
              \Fam{\chi}{
                \SemCoe{
                  \Rst{\chi}{r'}
                }{
                  \Rst{\chi}{r}
                }{
                  \VAbs{\gamma}{
                    \Act{\Swap{\gamma}{\alpha}}{A}
                  }
                }{
                  \Rst{\chi\circ\phi}{N}
                }
              }
            }
          }
        }
      }
    }
  }
  \and
  \inferrule{
    \ForceTest{\phi}{F}{
      \VHCom{r}{r'}{C}{M}{
        \Vec{
          \VFace{\xi_i}{
            \VAbs{\alpha_i}{N_i}
          }
        }
      }
    }
    \\
    \ForceTest{\RstId}{C}{
      \VPi{A}{\VClo{B}{\rho}{\pi}{\psi}}
    }
  }{
    \ForceTest{\phi}{
      \SemApp{F}{O}
    }{
      \Fresh{\beta}{
        \SemHCom{r}{r'}{
          \Rst{\psi}{
            \Eval{B}{\Squares*{\rho,\FamTest{O}{\phi}}}{\pi}
          }
        }{
          \SemApp{M}{\Rst{\phi}{O}}
        }{
          \Vec{
            \VFace{\xi_i}{
              \VAbs{\beta}{
                \SemApp{
                  \Act{
                    \Swap{\alpha_i}{\beta}
                  }{N_i}
                }{
                  \Rst{\phi}{O}
                }
              }
            }
          }
        }
      }
    }
  }
\end{mathparpagebreakable}

\begin{mathparpagebreakable}
  \inferrule{
    \ForceEq{\RstId}{r}{r'}
  }{
    \SemHCom{r}{r'}{C}{M}{
      \Vec{
        \VFace{\xi_i}{\VAbs{\alpha_i}{N_i}}
      }
    }
    \equiv
    \FamTest{M}{\RstId}
  }
  \and
  \inferrule{
    \exists_{\textit{min}}k,
    \ForceTrue{\RstId}{\xi_k}
  }{
    \SemHCom{r}{r'}{C}{M}{
      \Vec{
        \VFace{\xi_i}{\VAbs{\alpha_i}{N_i}}
      }
    }
    \equiv
    \FamTest{N_k}{
      \RstEquate{\alpha_k}{\FamTest{r'}{\RstId}}
    }
  }
  \and
  \inferrule{
    \ForceTest{\RstId}{C}{\VPi{A}{B}}
  }{
    \SemHCom{r}{r'}{C}{M}{
      \Vec{
        \VFace{\xi_i}{\VAbs{\alpha_i}{N_i}}
      }
    }
    \equiv
    \VHCom{r}{r'}{C}{M}{
      \Vec{
        \VFace{\xi_i}{\VAbs{\alpha_i}{N_i}}
      }
    }
  }
  \and
  \inferrule{
    \ForceTest{\RstId}{C}{\VBool}
  }{
    \SemHCom{r}{r'}{C}{M}{
      \Vec{
        \VFace{\xi_i}{\VAbs{\alpha_i}{N_i}}
      }
    }
    \equiv
    \FamTest{M}{\RstId}
  }
\end{mathparpagebreakable}

\[
  \SemCoe{r}{r'}{\VAbs{\alpha}{C}}{M}
  =
  \FmtVal{
    \begin{cases}
      \Cond{
        \models\FamTest{r}{\RstId}=\FamTest{r'}{\RstId}
      }{
        \FamTest{M}{\RstId}
      }
      \\
      \Cond{
        \FamTest{C}{\RstId}
        \equiv
        \VPi{A}{B}
      }{
        \VCoe{r}{r'}{\VAbs{\alpha}{C}}{M}
      }
      \\
      \Cond{
        \FamTest{C}{\RstId}
        \equiv
        \VBool
      }{
        \FamTest{M}{\RstId}
      }
    \end{cases}
  }
\]
\end{document}
