\documentclass{article}
\usepackage{stmaryrd}
\usepackage[landscape]{geometry}
\usepackage{fullpage}
\usepackage{jst}
\usepackage{mathpartir}
\usepackage{notation}

\newcommand\Eval[3]{
  \FmtFam{
    {\left\llbracket\FmtTm{#1}\right\rrbracket}_{\FmtVal{#2}}^{\FmtVal{#3}}
  }
}

\newcommand\ForceEq[3]{\FmtRst{#1}\vDash\FmtFam{#2}=\FmtFam{#3}}
\newcommand\ForceNotEq[3]{\FmtRst{#1}\vDash\FmtFam{#2}\not=\FmtFam{#3}}
\newcommand\ForceTrue[2]{\FmtRst{#1}\vDash\FmtFam{#2}}
\newcommand\ForceNotTrue[2]{\FmtRst{#1}\not\vDash\FmtFam{#2}}
\newcommand\ForceTest[3]{\FmtRst{#1}\vDash\FmtFam{#2}\Downarrow\FmtVal{#3}}

\title{cubical evaluation semantics}
\author{Carlo Angiuli \and Jon Sterling}

\begin{document}
\maketitle

I've been thinking a bit more carefully about the evaluation semantics and the
semantic domain. What I think we want to do is take a term and an environment
and return a family of values (indexed in restrictions); but crucially, I think
it is important that the environment be a vector of \emph{values} and not of
value-families. By studying carefully the case for instantiating closures
(where the rubber meets the road for variables), I think it becomes clear that
this is the right way.

To interpret a variable, we just project from the environment and ignore the
restriction. I think the way that we had been thinking of doing it would result
in the restriction from inside the closure infecting the argument.

\bigskip


Colors: \FmtTm{terms}, \FmtFam{value families}, \FmtVal{values},
\FmtRst{restrictions}. I am writing $\Rst{\phi}{F}$ to mean the reindexing of a
family by a restriction.

\begin{align*}
  \Eval{
    \TLam{M}
  }{\rho}{\pi}
  &=
  \Fam{\phi}{
    \VLam{
      \VClo{M}{\rho}{\pi}{\phi}
    }
  }
  \\
  \Eval{
    \TPi{A}{B}
  }{\rho}{\pi}
  &=
  \Fam{\phi}{
    \VPi{
      \Rst{\phi}{\Eval{A}{\rho}{\pi}}
    }{
      \VClo{B}{\rho}{\pi}{\phi}
    }
  }
  \\
  \Eval{
    \TApp{M}{N}
  }{\rho}{\pi}
  &=
  \SemApp{
    \Eval{M}{\rho}{\pi}
  }{
    \Eval{N}{\rho}{\pi}
  }
  \\
  \Eval{
    \TVar{i}
  }{\rho}{\pi}
  &=
  \Fam{\_}{
    \rho_i
  }
\end{align*}

We write $\ForceTest{\phi}{F}{V}$ as a shorthand for
$\FamTest{F}{\phi}\equiv\FmtVal{V}$.

\begin{mathparpagebreakable}
  \inferrule{
    \ForceTest{\phi}{F}{
      \VLam{
        \VClo{M}{\rho}{\pi}{\psi}
      }
    }
  }{
    \ForceTest{\phi}{
      \SemApp{F}{N}
    }{
      \FamTest{
        \Eval{M}{\Squares*{\rho, \FamTest{N}{\phi}}}{\pi}
      }{
        \psi
      }
    }
  }
  \and
  \inferrule{
    \ForceTest{\phi}{F}{\VUp{C}{R}}
    \\
    \ForceTest{\RstId}{C}{\VPi{A}{\VClo{B}{\rho}{\pi}{\psi}}}
  }{
    \ForceTest{\phi}{
      \SemApp{F}{N}
    }{
      \VUp{
        \Rst{\psi}{\Eval{B}{\Squares*{\rho,\FamTest{N}{\phi}}}{\pi}}
      }{
        \Parens*{
          \Fam{\chi}{
            \VApp{
              \Rst{\chi}{R}
            }{
              \Rst{\chi\circ\phi}{N}
            }
          }
        }
      }
    }
  }
  \and
  \inferrule{
    \ForceTest{\phi}{F}{
      \VCoe{r}{r'}{
        \VAbs{\alpha}{C}
      }{M}
    }
    \\
    \ForceTest{\RstId}{C}{
      \VPi{A}{\VClo{B}{\rho}{\pi}{\psi}}
    }
  }{
    \ForceTest{\phi}{
      \SemApp{F}{N}
    }{
      \Fresh{\beta}{
        \Fresh{\gamma}{
          \SemCoe{r}{r'}{
            \VAbs{\beta}{
              \Eval{B}{
                \Squares*{
                  \rho,
                  \SemCoe{r'}{\beta}{
                    \VAbs{\gamma}{
                      \Act{\Swap{\gamma}{\alpha}}{A}
                    }
                  }{
                    \FamTest{N}{\phi}
                  }
                }
              }{
                \Squares*{\pi, \Swap{\beta}{\alpha}}
              }
            }
          }{
            \SemApp{M}{
              \SemCoeFam{r'}{r}{
                \VAbs{\gamma}{
                  \Act{\Swap{\gamma}{\alpha}}{A}
                }
              }{
                \Rst{\phi}{N}
              }
            }
          }
        }
      }
    }
  }
  \and
  \inferrule{
    \ForceTest{\phi}{F}{
      \VHCom{r}{r'}{C}{M}{
        \Vec{
          \VBFace{\xi_i}{
            \VAbs{\alpha_i}{N_i}
          }
        }
      }
    }
    \\
    \ForceTest{\RstId}{C}{
      \VPi{A}{\VClo{B}{\rho}{\pi}{\psi}}
    }
  }{
    \ForceTest{\phi}{
      \SemApp{F}{O}
    }{
      \Fresh{\beta}{
        \SemHCom{r}{r'}{
          \Rst{\psi}{
            \Eval{B}{\Squares*{\rho,\FamTest{O}{\phi}}}{\pi}
          }
        }{
          \SemApp{M}{\Rst{\phi}{O}}
        }{
          \Vec{
            \VBFace{\xi_i}{
              \VAbs{\beta}{
                \SemApp{
                  \Act{
                    \Swap{\alpha_i}{\beta}
                  }{N_i}
                }{
                  \Rst{\phi}{O}
                }
              }
            }
          }
        }
      }
    }
  }
  \\
  \inferrule{}{
    \ForceTest{\phi}{
      \SemCoeFam{r}{r'}{
        \VAbs{\alpha}{A}
      }{M}
    }{
      \SemCoe{
        \Rst{\phi}{r}
      }{
        \Rst{\phi}{r'}
      }{
        \Fresh{\beta}{
          \VAbs{\beta}{
            \Rst{\phi}{
              \Parens*{\Act{\Swap{\beta}{\alpha}}{A}}
            }
          }
        }
      }{
        \Rst{\phi}{M}
      }
    }
  }
\end{mathparpagebreakable}

\begin{mathparpagebreakable}
  \inferrule{
    \ForceEq{\RstId}{r}{r'}
  }{
    \SemHCom{r}{r'}{C}{M}{
      \Vec{
        \VBFace{\xi_i}{\VAbs{\alpha_i}{N_i}}
      }
    }
    \equiv
    \FamTest{M}{\RstId}
  }
  \and
  \inferrule{
    \ForceNotEq{\RstId}{r}{r'}
    \\
    \exists_{\textit{min}}k,
    \ForceTrue{\RstId}{\xi_k}
  }{
    \SemHCom{r}{r'}{C}{M}{
      \Vec{
        \VBFace{\xi_i}{\VAbs{\alpha_i}{N_i}}
      }
    }
    \equiv
    \FamTest{N_k}{
      \RstEquate{\alpha_k}{\FamTest{r'}{\RstId}}
    }
  }
  \and
  \inferrule{
    \ForceNotEq{\RstId}{r}{r'}
    \\
    \Vec{\ForceNotTrue{\RstId}{\xi_i}}
    \\
    \ForceTest{\RstId}{C}{\VPi{A}{B}}
  }{
    \SemHCom{r}{r'}{C}{M}{
      \Vec{
        \VBFace{\xi_i}{\VAbs{\alpha_i}{N_i}}
      }
    }
    \equiv
    \VHCom{r}{r'}{C}{M}{
      \Vec{
        \VBFace{\xi_i}{\VAbs{\alpha_i}{N_i}}
      }
    }
  }
  \and
  \inferrule{
    \ForceNotEq{\RstId}{r}{r'}
    \\
    \Vec{\ForceNotTrue{\RstId}{\xi_i}}
    \\
    \ForceTest{\RstId}{C}{\VBool}
  }{
    \SemHCom{r}{r'}{C}{M}{
      \Vec{
        \VBFace{\xi_i}{\VAbs{\alpha_i}{N_i}}
      }
    }
    \equiv
    \FamTest{M}{\RstId}
  }
  \\
  \inferrule{}{
    \ForceTest{\phi}{
      \SemHComFam{r}{r'}{A}{M}{
        \Vec{
          \VBFace{\xi_i}{
            \VAbs{\alpha_i}{N_i}
          }
        }
      }
    }{
      \Fresh{\beta}{
        \SemHCom{
          \Rst{\phi}{r}
        }{
          \Rst{\phi}{r'}
        }{
          \Rst{\phi}{A}
        }{
          \Rst{\phi}{M}
        }{
          \Vec{
            \VBFace{
              \Rst{\phi}{\xi_i}
            }{
              \VAbs{
                \beta
              }{
                \Rst{\phi}{
                  \Parens*{\Act{\Swap{\beta}{\alpha_i}}{N_i}}
                }
              }
            }
          }
        }
      }
    }
  }
\end{mathparpagebreakable}

\begin{mathparpagebreakable}
  \inferrule{
    \ForceEq{\RstId}{r}{r'}
  }{
    \SemCoe{r}{r'}{\VAbs{\alpha}{C}}{M}
    \equiv
    \FamTest{M}{\RstId}
  }
  \and
  \inferrule{
    \ForceNotEq{\RstId}{r}{r'}
    \\
    \ForceTest{\RstId}{C}{\VPi{A}{B}}
  }{
    \SemCoe{r}{r'}{\VAbs{\alpha}{C}}{M}
    \equiv
    \VCoe{r}{r'}{\VAbs{\alpha}{C}}{M}
  }
  \and
  \inferrule{
    \ForceNotEq{\RstId}{r}{r'}
    \\
    \ForceTest{\RstId}{C}{\VBool}
  }{
    \SemCoe{r}{r'}{\VAbs{\alpha}{C}}{M}
    \equiv
    \FamTest{M}{\RstId}
  }
  \and
  \inferrule{
    \ForceNotEq{\RstId}{r}{r'}
    \\
    \ForceTest{\RstId}{C}{
      \VFCom{s}{s'}{A}{
        \Vec{
          \VBFace{\xi_i}{
            \VAbs{\beta}{B_i}
          }
        }
      }
    }
    \\
    \FmtRst{\phi_{r}}\triangleq{\Parens*{\RstEquate{\FamTest{r}{\RstId}}{\alpha}}}
    \\
    \FmtRst{\phi_{r'}}\triangleq{\Parens*{\RstEquate{\FamTest{r'}{\RstId}}{\alpha}}}
    \\\\
    \FmtFam{N_i}
    \triangleq
    \FmtFam{
      \SemCoeFam{s'}{\beta}{
        \VAbs{\beta}{B_i}
      }{
        \SemCoeFam{r}{\alpha}{
          \VAbs{\alpha}{
            \Rst{
              \Parens*{\RstEquate{s'}{\beta}}
            }{B_i}
          }
        }{M}
      }
    }
    \\\\
    \FmtFam{O_t}\triangleq
    \SemHComFam{
      \Rst{\phi_r}{s'}
    }{t}{
      \Rst{\phi_r}{A}
    }{
      \Parens*{
        \SemCapFam{
          \Rst{\phi_r}{s}
        }{
          \Rst{\phi_r}{s'}
        }{M}{
          \Vec{
            \VBFace{
              \Rst{\phi_r}{\xi_i}
            }{
              \VAbs{\beta}{
                \Rst{\RstForall{\beta}{\phi_r}}{B_i}
              }
            }
          }
        }
      }
    }{
      \Vec{
        \VBFace{
          \Rst{\phi_r}{\xi_i}
        }{
          \Fresh{\delta}{
            \VAbs{\delta}{
              \SemCoeFam{\delta}{
                \Rst{\phi_r}{s}
              }{
                \VAbs{\beta}{
                  \Rst{
                    \RstForall{\beta}{\phi_r}
                  }{B_i}
                }
              }{
                \SemCoeFam{
                  \Rst{\phi_r}{s'}
                }{\delta}{
                  \VAbs{\beta}{
                    \Rst{
                      \RstForall{\beta}{\phi_r}
                    }{B_i}
                  }
                }{M}
              }
            }
          }
        }
      }
    }
    \\\\
    \FmtFam{P}\triangleq
    \SemGComFam{r}{r'}{
      \VAbs{\alpha}{A}
    }{
      \Rst{
        \Parens*{\RstEquate{\gamma}{\FamTest{s}{\phi_r}}}
      }{O_\gamma}
    }{
      \Vec{
        \VBFace{\xi_i}{
          \Fresh{\gamma}{
            \VAbs{\gamma}{
              \Rst{
                \Parens*{
                  \RstEquate{
                    \Act{\Swap{\gamma}{\alpha}}{s}
                  }{\beta}
                }
              }{
                \Parens*{
                  \Act{\Swap{\gamma}{\alpha}}{N_i}
                }
              }
            }
          }
        }
        \vert_{
          \FmtVal{\alpha}\# \FamTest{\xi_i}{\RstId}
        }
      },
      \VBFace{
        s = s'
      }{
        \Fresh{\gamma}{
          \VAbs{\gamma}{
            \SemCoeFam{r}{\gamma}{
              \VAbs{\alpha}{A}
            }{M}
          }
        }
      }
      \vert_{
        \FmtVal{\alpha}\# \Squares*{\FamTest{s}{\RstId},\FamTest{s'}{\RstId}}
      }
    }
    \\\\
    \FmtFam{Q_i^t}\triangleq
    \SemGComFam{
      \Rst{\phi_{r'}}{s}
    }{t}{
      \VAbs{\beta}{
        \Rst{
          \RstForall{\beta}{\phi_{r'}}
        }{B_i}
      }
    }{P}{
      \Vec{
        \VBFace{
          \xi_i
        }{
          \Fresh{\eta}{
            \VAbs{\eta}{
              \Rst{
                \phi_{r'}
              }{
                \Parens*{
                  \Act{\Swap{\eta}{\beta}}{N_i}
                }
              }
            }
          }
        }
        \vert_{
          \FmtVal{\alpha}\#\FamTest{\xi_i}{\RstId}
        }
      },
      \VBFace{
        r=r'
      }{
        \Fresh{\eta}{
          \VAbs{\eta}{
            \SemCoeFam{
              \Rst{\phi_{r'}}{s'}
            }{\eta}{
              \VAbs{\beta}{
                \Rst{
                  \RstForall{\beta}{\phi_{r'}}
                }{B_i}
              }
            }{M}
          }
        }
      }
    }
    \\\\
    \FmtFace{\Vec{T}}\triangleq
    \FmtFace{
      \Vec{
        \VBFace{\xi_i}{
          \Fresh{\delta}{
            \VAbs{\delta}{
              \SemCoeFam{\delta}{
                \Rst{\phi_{r'}}{s}
              }{
                \VAbs{\beta}{
                  \Rst{\RstForall{\beta}{\phi_{r'}}}{B_i}
                }
              }{
                \Rst{\phi_{r'}}{
                  \Parens*{\Act{\Swap{\delta}{\beta}}{N_i}}
                }
              }
            }
          }
        }
        \vert_{
          \FmtVal{\alpha} \# \FamTest{\xi_i}{\RstId}
        },
%
        \VBFace{
          \Rst{\phi_{r'}}{\xi_i}
        }{
          \Fresh{\delta}{
            \VAbs{\delta}{
              \SemCoeFam{\delta}{
                \Rst{\phi_{r'}}{s}
              }{
                \VAbs{\beta}{
                  \Rst{
                    \RstForall{\beta}{\phi_{r'}}
                  }{B_i}
                }
              }{
                Q_i^\delta
              }
            }
          }
        }
        \vert_{
          \FmtVal{\alpha}\in\FamTest{\xi_i}{\RstId}
        }
      }
      ,
      \VBFace{r=r'}{
        \Fresh{\gamma}{
          \VAbs{\gamma}{O_\gamma}
        }
      }
    }
    \\\\
    \FmtFace{\Vec{U}}\triangleq
    \FmtFace{
      \Vec{
        \VFace{\xi_i}{
          \SemCoeFam{r}{r'}{
            \Fresh{\gamma}{
              \VAbs{\gamma}{
                \Rst{
                  \Parens*{
                    \RstEquate{
                      \Act{\Swap{\gamma}{\alpha}}{\FamTest{s'}{\RstId}}
                    }{\beta}
                  }
                }{
                  \Act{\Swap{\gamma}{\alpha}}{B_i}
                }
              }
            }
          }{M}
        }
        \vert_{
          \FmtVal{\alpha}\#\FamTest{\xi_i}{\RstId}
        },
        \VFace{
          \Rst{\phi_{r'}}{\xi_i}
        }{
          Q_i^{\Rst{\phi_{r'}}{s'}}
        }
        \vert_{
          \FmtVal{\alpha}\in\FamTest{\xi_i}{\RstId}
        }
      }
    }
  }{
    \SemCoe{r}{r'}{\VAbs{\alpha}{C}}{M}
    \equiv
    \SemBox{
      \Rst{\phi_{r'}}{s}
    }{
      \Rst{\phi_{r'}}{s'}
    }{
      \Parens*{
        \SemHComFam{
          \Rst{\phi_{r'}}{s}
        }{
          \Rst{\phi_{r'}}{s'}
        }{
          \Rst{\phi_{r'}}{A}
        }{
          P
        }{
          \Vec{T}
        }
      }
    }{
      \Vec{U}
    }
  }
\end{mathparpagebreakable}

\end{document}
